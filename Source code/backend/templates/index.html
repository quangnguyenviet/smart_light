<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Light Control</title>
    <!-- T·∫£i Tailwind CSS ƒë·ªÉ t·∫°o giao di·ªán hi·ªán ƒë·∫°i v√† responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* ƒê·ªãnh nghƒ©a font Inter */
      body {
        font-family: "Inter", sans-serif;
      }
      /* Custom style cho thanh tr∆∞·ª£t */
      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #4f46e5;
        cursor: pointer;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      }
      input[type="range"]::-moz-range-thumb {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background: #4f46e5;
        cursor: pointer;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex items-start justify-center p-4">
    <div
      class="bg-white p-6 sm:p-8 rounded-xl shadow-2xl w-full max-w-md mt-10"
    >
      <h1 class="text-3xl font-extrabold text-center text-indigo-700 mb-6">
        üè† Smart Light Control
      </h1>

      <div id="controls" class="space-y-6">
        <!-- HI·ªÇN TH·ªä TR·∫†NG TH√ÅI -->
        <div
          id="status-display"
          class="text-center p-4 rounded-lg shadow-inner bg-indigo-50"
        >
          <p class="text-lg font-semibold text-gray-600">
            Tr·∫°ng th√°i hi·ªán t·∫°i:
          </p>
          <p id="current-mode" class="text-2xl font-bold text-indigo-600 mt-1">
            CH·∫æ ƒê·ªò: MANUAL
          </p>
          <p id="current-state" class="text-xl font-medium text-gray-800">
            ƒê√àN: T·∫ÆT
          </p>
        </div>

        <!-- PH·∫¶N ƒêI·ªÄU CH·ªàNH ƒê·ªò S√ÅNG (M·ªöI) -->
        <div class="border-t pt-6">
          <h3
            class="text-xl font-semibold text-gray-700 mb-4 flex justify-between items-center"
          >
            ƒêi·ªÅu ch·ªânh ƒê·ªô s√°ng
            <span id="brightness-value" class="text-indigo-600 font-bold"
              >100%</span
            >
          </h3>
          <input
            type="range"
            min="0"
            max="100"
            value="100"
            id="brightness-slider"
            class="w-full h-2 bg-gray-300 rounded-lg appearance-none cursor-pointer"
            oninput="document.getElementById('brightness-value').innerText = this.value + '%';"
            onmouseup="sendBrightnessCommand(this.value)"
            ontouchend="sendBrightnessCommand(this.value)"
          />
          <p class="text-sm text-gray-500 mt-2">
            ƒê·ªô s√°ng ch·ªâ c√≥ t√°c d·ª•ng ·ªü ch·∫ø ƒë·ªô Manual.
          </p>
        </div>

        <!-- N√öT B·∫¨T/T·∫ÆT -->
        <div
          class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-4 border-t pt-6"
        >
          <!-- N√∫t B·∫¨T ƒê√àN -->
          <button
            id="btn-on"
            class="w-full sm:w-1/2 p-4 rounded-xl text-white font-medium bg-green-500 hover:bg-green-600 shadow-md transition duration-150 ease-in-out transform hover:scale-[1.02] active:scale-[0.98]"
            onclick="sendCommand('on')"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 inline-block mr-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"
              />
            </svg>
            B·∫¨T ƒê√àN
          </button>

          <!-- N√∫t T·∫ÆT ƒê√àN -->
          <button
            id="btn-off"
            class="w-full sm:w-1/2 p-4 rounded-xl text-white font-medium bg-red-500 hover:bg-red-600 shadow-md transition duration-150 ease-in-out transform hover:scale-[1.02] active:scale-[0.98]"
            onclick="sendCommand('off')"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6 inline-block mr-2"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M13 10V3L4 14h7v7l9-11h-7z"
              />
            </svg>
            T·∫ÆT ƒê√àN
          </button>
        </div>

        <div class="pt-2">
          <!-- N√∫t Chuy·ªÉn Mode -->
          <button
            id="btn-mode"
            class="w-full p-3 rounded-xl bg-indigo-600 text-white font-semibold shadow-lg hover:bg-indigo-700 transition duration-150 ease-in-out transform hover:scale-[1.01] active:scale-[0.99]"
            onclick="toggleMode()"
          >
            Chuy·ªÉn sang AUTO MODE
          </button>
        </div>

        <!-- Khung th√¥ng b√°o t·∫°m th·ªùi sau khi g·ª≠i l·ªánh -->
        <div
          id="message-box"
          class="mt-4 p-3 text-sm rounded-lg hidden text-center"
        ></div>
      </div>
    </div>

    <script>
      // C·∫•u h√¨nh ƒë·ªÉ kh·ªõp v·ªõi Payload m√¥ t·∫£ trong y√™u c·∫ßu ban ƒë·∫ßu
      const USER_ID = "light1";
      const DEVICE_ID = "light1";
      const API_ENDPOINT = "/api/device/command";

      // Tr·∫°ng th√°i hi·ªán t·∫°i c·ªßa UI (d√πng ƒë·ªÉ chuy·ªÉn ƒë·ªïi n√∫t mode)
      let currentUIMode = "manual";
      let currentUIState = "off";

      // =======================================================
      // H√ÄM HI·ªÇN TH·ªä & C·∫¨P NH·∫¨T UI
      // =======================================================

      function updateUI(mode, state) {
        currentUIMode = mode;
        currentUIState = state;

        const modeDisplay = document.getElementById("current-mode");
        const stateDisplay = document.getElementById("current-state");
        const modeBtn = document.getElementById("btn-mode");

        // 1. C·∫≠p nh·∫≠t tr·∫°ng th√°i v√† mode
        modeDisplay.innerText = `CH·∫æ ƒê·ªò: ${mode.toUpperCase()}`;
        stateDisplay.innerText = `ƒê√àN: ${state.toUpperCase()}`;

        // 2. C·∫≠p nh·∫≠t n√∫t Mode
        if (mode === "manual") {
          modeDisplay.classList.remove("text-green-600");
          modeDisplay.classList.add("text-indigo-600");
          modeBtn.innerText = "Chuy·ªÉn sang AUTO MODE (PIR)";
          modeBtn.classList.remove("bg-green-600");
          modeBtn.classList.add("bg-indigo-600");
        } else {
          modeDisplay.classList.remove("text-indigo-600");
          modeDisplay.classList.add("text-green-600");
          modeBtn.innerText = "Chuy·ªÉn sang MANUAL MODE";
          modeBtn.classList.remove("bg-indigo-600");
          modeBtn.classList.add("bg-green-600");
        }

        // 3. C·∫≠p nh·∫≠t m√†u n√∫t B·∫≠t/T·∫Øt (optional visual feedback)
        const onBtn = document.getElementById("btn-on");
        const offBtn = document.getElementById("btn-off");

        if (state === "on") {
          stateDisplay.classList.add("text-yellow-600");
          stateDisplay.classList.remove("text-gray-800");
        } else {
          stateDisplay.classList.add("text-gray-800");
          stateDisplay.classList.remove("text-yellow-600");
        }
      }

      // H√†m hi·ªÉn th·ªã th√¥ng b√°o t·∫°m th·ªùi
      function showMessage(text, isError = false) {
        const msgBox = document.getElementById("message-box");
        msgBox.innerText = text;
        msgBox.classList.remove(
          "hidden",
          "bg-blue-100",
          "text-blue-800",
          "bg-red-100",
          "text-red-800",
          "bg-green-100",
          "text-green-800"
        );

        if (isError) {
          msgBox.classList.add("bg-red-100", "text-red-800");
        } else if (text.includes("th√†nh c√¥ng")) {
          msgBox.classList.add("bg-green-100", "text-green-800");
        } else {
          msgBox.classList.add("bg-blue-100", "text-blue-800");
        }

        setTimeout(() => {
          msgBox.classList.add("hidden");
        }, 3000); // ·∫®n sau 3 gi√¢y
      }

      // =======================================================
      // H√ÄM G·ª¨I L·ªÜNH ƒêI·ªÄU KHI·ªÇN
      // =======================================================

      /**
       * G·ª≠i l·ªánh c∆° b·∫£n B·∫≠t/T·∫Øt ƒë·∫øn Backend API
       * @param {string} action - 'on' ho·∫∑c 'off'
       */
      function sendCommand(action) {
        let payload = {
          user_id: USER_ID,
          device_id: DEVICE_ID,
          state: action,
          // Khi nh·∫•n B·∫≠t/T·∫Øt, lu√¥n chuy·ªÉn v·ªÅ manual mode
          mode: "manual",
          brightness: 100, // M·∫∑c ƒë·ªãnh brightness 100 khi b·∫≠t/t·∫Øt th·ªß c√¥ng
        };

        // C·∫≠p nh·∫≠t gi√° tr·ªã thanh tr∆∞·ª£t v·ªÅ 100 n·∫øu b·∫≠t/t·∫Øt th·ªß c√¥ng
        document.getElementById("brightness-slider").value = 100;
        document.getElementById("brightness-value").innerText = "100%";

        executeFetch(payload, `ƒêang g·ª≠i l·ªánh '${action.toUpperCase()}'...`);
      }

      /**
       * G·ª≠i l·ªánh ƒêi·ªÅu ch·ªânh ƒë·ªô s√°ng (M·ªöI)
       * @param {number} brightness - Gi√° tr·ªã ƒë·ªô s√°ng (0-100)
       */
      function sendBrightnessCommand(brightness) {
        // L·ªánh ƒëi·ªÅu ch·ªânh ƒë·ªô s√°ng ch·ªâ c√≥ √Ω nghƒ©a khi ·ªü MANUAL MODE V√Ä B·∫¨T ƒê√àN
        let payload = {
          user_id: USER_ID,
          device_id: DEVICE_ID,
          state: "on", // Ph·∫£i lu√¥n b·∫≠t ƒë√®n ƒë·ªÉ ƒëi·ªÅu ch·ªânh ƒë·ªô s√°ng
          mode: "manual",
          brightness: parseInt(brightness),
        };

        // Ch·ªâ g·ª≠i l·ªánh n·∫øu ·ªü manual mode
        if (currentUIMode === "auto") {
          showMessage(
            "‚ö†Ô∏è Ph·∫£i chuy·ªÉn sang MANUAL MODE ƒë·ªÉ ƒëi·ªÅu ch·ªânh ƒë·ªô s√°ng!",
            true
          );
          return;
        }

        executeFetch(payload, `ƒêang ƒëi·ªÅu ch·ªânh ƒë·ªô s√°ng t·ªõi ${brightness}%...`);
      }

      /**
       * Chuy·ªÉn ƒë·ªïi gi·ªØa ch·∫ø ƒë·ªô Auto v√† Manual
       */
      function toggleMode() {
        const newMode = currentUIMode === "manual" ? "auto" : "manual";

        let payload = {
          user_id: USER_ID,
          device_id: DEVICE_ID,
          state: "off", // ƒê·∫∑t tr·∫°ng th√°i t·∫Øt khi chuy·ªÉn mode (ho·∫∑c gi·ªØ nguy√™n tr·∫°ng th√°i c≈©)
          mode: newMode,
        };

        executeFetch(
          payload,
          `ƒêang chuy·ªÉn sang ch·∫ø ƒë·ªô ${newMode.toUpperCase()}...`
        );
      }

      // H√†m th·ª±c thi Fetch API chung
      function executeFetch(payload, loadingMessage) {
        showMessage(loadingMessage);

        fetch(API_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        })
          .then((res) => {
            if (res.ok) {
              showMessage(`L·ªánh ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!`);
              // Gi·∫£ ƒë·ªãnh c·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c
              if (payload.mode) updateUI(payload.mode, payload.state);
            } else {
              throw new Error(`L·ªói HTTP: ${res.status}`);
            }
          })
          .catch((error) => {
            console.error("L·ªói khi g·ª≠i l·ªánh:", error);
            showMessage(`G·ª≠i l·ªánh th·∫•t b·∫°i: ${error.message}`, true);
          });
      }

      // Kh·ªüi t·∫°o tr·∫°ng th√°i UI ban ƒë·∫ßu
      window.onload = function () {
        updateUI(currentUIMode, currentUIState);
      };
    </script>
  </body>
</html>
